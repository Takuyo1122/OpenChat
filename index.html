<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>チャット</title>
  <style>
    body{margin:0;height:100vh;display:flex;flex-direction:column;font-family:sans-serif;background:#0f1724;color:#fff}
    #msgs{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:6px}
    .msg{padding:8px 12px;border-radius:12px;max-width:70%;background:#222;opacity:0;transform:translateY(6px);transition:.2s}
    .msg.show{opacity:1;transform:none}
    .me{margin-left:auto;background:#7c5cff;color:#000}
    form{display:flex;padding:10px;gap:6px;background:#111}
    textarea{flex:1;resize:none;border:0;border-radius:8px;padding:8px;font-size:14px;background:#222;color:#fff;outline:none}
    button{padding:0 14px;border:0;border-radius:8px;background:#7c5cff;color:#000;font-weight:bold}
  </style>
</head>
<body>
  <div id="msgs"></div>
  <form id="composer" onsubmit="return false">
    <textarea id="text" placeholder="メッセージ..." rows="1"></textarea>
    <button id="send">送信</button>
  </form>

  <script>
    const msgsEl=document.getElementById('msgs');
    const textEl=document.getElementById('text');
    const sendBtn=document.getElementById('send');

    let channel;
    try{
      channel=new BroadcastChannel('simple-chat');
      channel.onmessage=e=>receive(e.data);
    }catch(e){
      window.addEventListener('storage',ev=>{
        if(ev.key==='simple-chat-msg')receive(JSON.parse(ev.newValue));
      });
    }

    const seen=new Set();
    function render(msg,mine){
      if(seen.has(msg.id))return;seen.add(msg.id);
      const el=document.createElement('div');
      el.className='msg'+(mine?' me':'');
      el.textContent=msg.text;
      msgsEl.appendChild(el);
      requestAnimationFrame(()=>el.classList.add('show'));
      msgsEl.scrollTop=msgsEl.scrollHeight;
    }

    function send(){
      const text=textEl.value.trim();
      if(!text)return;
      const msg={id:Date.now()+Math.random(),text};
      render(msg,true);
      if(channel)channel.postMessage(msg);
      try{localStorage.setItem('simple-chat-msg',JSON.stringify(msg))}catch{}
      textEl.value='';
    }

    function receive(msg){if(msg)render(msg,false)}

    sendBtn.onclick=send;
    textEl.onkeydown=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}};
  </script>
</body>
</html>
